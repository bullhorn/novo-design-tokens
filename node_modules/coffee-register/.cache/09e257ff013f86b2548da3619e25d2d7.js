var Listr, chalk, exec, fs, glob, path, regEx;

fs = require('fs');

path = require('path');

glob = require('glob');

chalk = require('chalk');

Listr = require('@danielkalen/listr');

exec = require('child_process').exec;

regEx = require('./regex');

module.exports = function(options) {
  return new Promise(function(finish) {
    var executeCommand, finalLogs, formatOutputMessage, getDirName, globOptions, isValidOutput, outputFinalLogs;
    finalLogs = {
      'log': {},
      'error': {}
    };
    globOptions = {};
    if (options.ignore) {
      globOptions.ignore = options.ignore;
    }
    if (options.nodir) {
      globOptions.nodir = options.nodir;
    }
    glob(options.glob, globOptions, function(err, files) {
      var tasks;
      if (err) {
        return console.error(err);
      } else {
        tasks = new Listr(files.map((function(_this) {
          return function(file) {
            return {
              title: "Executing command: " + (chalk.dim(file)),
              task: function() {
                return executeCommand(file);
              }
            };
          };
        })(this)), options);
        return tasks.run().then(outputFinalLogs, outputFinalLogs);
      }
    });
    executeCommand = function(filePath) {
      return new Promise(function(resolve, reject) {
        var command, pathParams;
        pathParams = path.parse(path.resolve(filePath));
        pathParams.reldir = getDirName(pathParams, path.resolve(filePath));
        command = options.command.replace(regEx.placeholder, function(entire, placeholder) {
          switch (false) {
            case placeholder !== 'path':
              return filePath;
            case pathParams[placeholder] == null:
              return pathParams[placeholder];
            default:
              return entire;
          }
        });
        if (options.forceColor && process.platform !== 'win32') {
          command = "FORCE_COLOR=true " + command;
        }
        return exec(command, function(err, stdout, stderr) {
          if (isValidOutput(stdout)) {
            finalLogs.log[filePath] = stdout;
          }
          if (isValidOutput(stderr) && !isValidOutput(err)) {
            finalLogs.log[filePath] = stderr;
          } else if (isValidOutput(err)) {
            finalLogs.error[filePath] = stderr || err;
          }
          if (isValidOutput(err)) {
            return reject();
          } else {
            return resolve();
          }
        });
      });
    };
    getDirName = function(pathParams, filePath) {
      var dirInGlob;
      dirInGlob = options.glob.match(/^[^\*\/]*/)[0];
      dirInGlob += dirInGlob ? '/' : '';
      return filePath.replace(pathParams.base, '').replace(process.cwd() + ("/" + dirInGlob), '').slice(0, -1);
    };
    isValidOutput = function(output) {
      return output && output !== 'null' && ((typeof output === 'string' && output.length >= 1) || (typeof output === 'object'));
    };
    formatOutputMessage = function(message) {
      if (options.trim) {
        return message.slice(0, options.trim);
      } else {
        return message;
      }
    };
    return outputFinalLogs = function() {
      var file, message, ref, ref1;
      if (Object.keys(finalLogs.log).length || Object.keys(finalLogs.error).length) {
        process.stdout.write('\n\n');
        ref = finalLogs.log;
        for (file in ref) {
          message = ref[file];
          console.log(chalk.bgWhite.black.bold("Output") + ' ' + chalk.dim(file));
          console.log(formatOutputMessage(message));
        }
        ref1 = finalLogs.error;
        for (file in ref1) {
          message = ref1[file];
          console.log(chalk.bgRed.white.bold("Error") + ' ' + chalk.dim(file));
          console.log(formatOutputMessage(message));
        }
        return finish();
      }
    };
  });
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUE7O0FBQUEsRUFBQSxHQUFLLE9BQUEsQ0FBUSxJQUFSOztBQUNMLElBQUEsR0FBTyxPQUFBLENBQVEsTUFBUjs7QUFDUCxJQUFBLEdBQU8sT0FBQSxDQUFRLE1BQVI7O0FBQ1AsS0FBQSxHQUFRLE9BQUEsQ0FBUSxPQUFSOztBQUNSLEtBQUEsR0FBUSxPQUFBLENBQVEsb0JBQVI7O0FBQ1IsSUFBQSxHQUFPLE9BQUEsQ0FBUSxlQUFSLENBQXdCLENBQUM7O0FBQ2hDLEtBQUEsR0FBUSxPQUFBLENBQVEsU0FBUjs7QUFHUixNQUFNLENBQUMsT0FBUCxHQUFpQixTQUFDLE9BQUQ7U0FBWSxJQUFJLE9BQUosQ0FBWSxTQUFDLE1BQUQ7QUFDeEMsUUFBQTtJQUFBLFNBQUEsR0FBWTtNQUFBLEtBQUEsRUFBTSxFQUFOO01BQVUsT0FBQSxFQUFRLEVBQWxCOztJQUNaLFdBQUEsR0FBYztJQUNkLElBQUcsT0FBTyxDQUFDLE1BQVg7TUFBdUIsV0FBVyxDQUFDLE1BQVosR0FBcUIsT0FBTyxDQUFDLE9BQXBEOztJQUNBLElBQUcsT0FBTyxDQUFDLEtBQVg7TUFBc0IsV0FBVyxDQUFDLEtBQVosR0FBb0IsT0FBTyxDQUFDLE1BQWxEOztJQUVBLElBQUEsQ0FBSyxPQUFPLENBQUMsSUFBYixFQUFtQixXQUFuQixFQUFnQyxTQUFDLEdBQUQsRUFBTSxLQUFOO0FBQWUsVUFBQTtNQUFBLElBQUcsR0FBSDtBQUFZLGVBQU8sT0FBTyxDQUFDLEtBQVIsQ0FBYyxHQUFkLEVBQW5CO09BQUEsTUFBQTtRQUM5QyxLQUFBLEdBQVEsSUFBSSxLQUFKLENBQVUsS0FBSyxDQUFDLEdBQU4sQ0FBVSxDQUFBLFNBQUEsS0FBQTtpQkFBQSxTQUFDLElBQUQ7bUJBQzNCO2NBQUEsS0FBQSxFQUFPLHFCQUFBLEdBQXFCLENBQUMsS0FBSyxDQUFDLEdBQU4sQ0FBVSxJQUFWLENBQUQs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QUFBO2VBR0MsUUFIRDs7SUFEcUI7V0FXdEIsZUFBQSxHQUFrQixTQUFBO0FBQUssVUFBQTtNQUFBLElBQUcsTUFBTSxDQUFDLElBQVAsQ0FBWSxTQUFTLENBQUMsR0FBdEIsQ0FBMEIsQ0FBQyxNQUEzQixJQUFxQyxNQUFNLENBQUMsSUFBUCxDQUFZLFNBQVMsQ0FBQyxLQUF0QixDQUE0QixDQUFDLE1BQXJFO1FBQ3RCLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBZixDQUFxQixNQUFyQjtBQUNBO0FBQUEsYUFBQSxXQUFBOztVQUNDLE9BQU8sQ0FBQyxHQUFSLENBQVksS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBcEIsQ0FBeUIsUUFBekIsQ0FBQSxHQUFtQyxHQUFuQyxHQUF1QyxLQUFLLENBQUMsR0FBTixDQUFVLElBQVYsQ0FBbkQ7VUFDQSxPQUFPLENBQUMsR0FBUixDQUFZLG1CQUFBLENBQW9CLE9BQXBCLENBQVo7QUFGRDtBQUlBO0FBQUEsYUFBQSxZQUFBOztVQUNDLE9BQU8sQ0FBQyxHQUFSLENBQVksS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBbEIsQ0FBdUIsT0FBdkIsQ0FBQSxHQUFnQyxHQUFoQyxHQUFvQyxLQUFLLENBQUMsR0FBTixDQUFVLElBQVYsQ0FBaEQ7VUFDQSxPQUFPLENBQUMsR0FBUixDQUFZLG1CQUFBLENBQW9CLE9BQXBCLENBQVo7QUFGRDtlQUlBLE1BQUEsQ0FBQSxFQVZzQjs7SUFBTDtFQWhGc0IsQ0FBWjtBQUFaIiwic291cmNlc0NvbnRlbnQiOlsiZnMgPSByZXF1aXJlKCdmcycpXG5wYXRoID0gcmVxdWlyZSgncGF0aCcpXG5nbG9iID0gcmVxdWlyZSgnZ2xvYicpXG5jaGFsayA9IHJlcXVpcmUoJ2NoYWxrJylcbkxpc3RyID0gcmVxdWlyZSAnQGRhbmllbGthbGVuL2xpc3RyJ1xuZXhlYyA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKS5leGVjXG5yZWdFeCA9IHJlcXVpcmUgJy4vcmVnZXgnXG5cblxubW9kdWxlLmV4cG9ydHMgPSAob3B0aW9ucyktPiBuZXcgUHJvbWlzZSAoZmluaXNoKS0+XG5cdGZpbmFsTG9ncyA9ICdsb2cnOnt9LCAnZXJyb3InOnt9XG5cdGdsb2JPcHRpb25zID0ge31cblx0aWYgb3B0aW9ucy5pZ25vcmUgdGhlbiBnbG9iT3B0aW9ucy5pZ25vcmUgPSBvcHRpb25zLmlnbm9yZVxuXHRpZiBvcHRpb25zLm5vZGlyIHRoZW4gZ2xvYk9wdGlvbnMubm9kaXIgPSBvcHRpb25zLm5vZGlyXG5cblx0Z2xvYiBvcHRpb25zLmdsb2IsIGdsb2JPcHRpb25zLCAoZXJyLCBmaWxlcyktPiBpZiBlcnIgdGhlbiByZXR1cm4gY29uc29sZS5lcnJvcihlcnIpIGVsc2Vcblx0XHR0YXNrcyA9IG5ldyBMaXN0ciBmaWxlcy5tYXAoKGZpbGUpPT5cblx0XHRcdHRpdGxlOiBcIkV4ZWN1dGluZyBjb21tYW5kOiAje2NoYWxrLmRpbShmaWxlKX1cIlx0XHRcblx0XHRcdHRhc2s6ICgpPT4gZXhlY3V0ZUNvbW1hbmQoZmlsZSlcblx0XHQpLCBvcHRpb25zICMgc2FtZSBhcyB7Y29uY3VycmVudDpvcHRpb25zLmNvbmN1cnJlbnR9XG5cblx0XHR0YXNrcy5ydW4oKS50aGVuKG91dHB1dEZpbmFsTG9ncywgb3V0cHV0RmluYWxMb2dzKVxuXG5cblxuXHRleGVjdXRlQ29tbWFuZCA9IChmaWxlUGF0aCktPiBuZXcgUHJvbWlzZSAocmVzb2x2ZSwgcmVqZWN0KS0+XG5cdFx0cGF0aFBhcmFtcyA9IHBhdGgucGFyc2UgcGF0aC5yZXNvbHZlKGZpbGVQYXRoKVxuXHRcdHBhdGhQYXJhbXMucmVsZGlyID0gZ2V0RGlyTmFtZShwYXRoUGFyYW1zLCBwYXRoLnJlc29sdmUoZmlsZVBhdGgpKVxuXG5cdFx0Y29tbWFuZCA9IG9wdGlvbnMuY29tbWFuZC5yZXBsYWNlIHJlZ0V4LnBsYWNlaG9sZGVyLCAoZW50aXJlLCBwbGFjZWhvbGRlciktPiBzd2l0Y2hcblx0XHRcdHdoZW4gcGxhY2Vob2xkZXIgaXMgJ3BhdGgnIHRoZW4gZmlsZVBhdGhcblx0XHRcdHdoZW4gcGF0aFBhcmFtc1twbGFjZWhvbGRlcl0/IHRoZW4gcGF0aFBhcmFtc1twbGFjZWhvbGRlcl1cblx0XHRcdGVsc2UgZW50aXJlXG5cdFx0XG5cdFx0aWYgb3B0aW9ucy5mb3JjZUNvbG9yIGFuZCBwcm9jZXNzLnBsYXRmb3JtIGlzbnQgJ3dpbjMyJ1xuXHRcdFx0Y29tbWFuZCA9IFwiRk9SQ0VfQ09MT1I9dHJ1ZSAje2NvbW1hbmR9XCJcblxuXHRcdGV4ZWMgY29tbWFuZCwgKGVyciwgc3Rkb3V0LCBzdGRlcnIpLT5cblx0XHRcdGlmIGlzVmFsaWRPdXRwdXQoc3Rkb3V0KSB0aGVuIGZpbmFsTG9ncy5sb2dbZmlsZVBhdGhdID0gc3Rkb3V0XG5cblx0XHRcdGlmIGlzVmFsaWRPdXRwdXQoc3RkZXJyKSBhbmQgbm90IGlzVmFsaWRPdXRwdXQoZXJyKVxuXHRcdFx0XHRmaW5hbExvZ3MubG9nW2ZpbGVQYXRoXSA9IHN0ZGVyclxuXHRcdFx0ZWxzZSBpZiBpc1ZhbGlkT3V0cHV0KGVycilcblx0XHRcdFx0ZmluYWxMb2dzLmVycm9yW2ZpbGVQYXRoXSA9IHN0ZGVyciBvciBlcnJcblxuXHRcdFx0aWYgaXNWYWxpZE91dHB1dChlcnIpIHRoZW4gcmVqZWN0KCkgZWxzZSByZXNvbHZlKClcblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXHQjIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXHQjIyBIZWxwZXJzXG5cdCMjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFxuXHRnZXREaXJOYW1lID0gKHBhdGhQYXJhbXMsIGZpbGVQYXRoKS0+XG5cdFx0ZGlySW5HbG9iID0gb3B0aW9ucy5nbG9iLm1hdGNoKC9eW15cXCpcXC9dKi8pWzBdXG5cdFx0ZGlySW5HbG9iICs9IGlmIGRpckluR2xvYiB0aGVuICcvJyBlbHNlICcnXG5cdFx0ZmlsZVBhdGhcblx0XHRcdC5yZXBsYWNlIHBhdGhQYXJhbXMuYmFzZSwgJydcblx0XHRcdC5yZXBsYWNlIHByb2Nlc3MuY3dkKCkrXCIvI3tkaXJJbkdsb2J9XCIsICcnXG5cdFx0XHQuc2xpY2UoMCwgLTEpXG5cblx0aXNWYWxpZE91dHB1dCA9IChvdXRwdXQpLT5cblx0XHRvdXRwdXQgYW5kXG5cdFx0b3V0cHV0IGlzbnQgJ251bGwnIGFuZFxuXHRcdChcblx0XHRcdCh0eXBlb2Ygb3V0cHV0IGlzICdzdHJpbmcnIGFuZCBvdXRwdXQubGVuZ3RoID49IDEpIG9yXG5cdFx0XHQodHlwZW9mIG91dHB1dCBpcyAnb2JqZWN0Jylcblx0XHQpXG5cblx0Zm9ybWF0T3V0cHV0TWVzc2FnZSA9IChtZXNzYWdlKS0+XG5cdFx0aWYgb3B0aW9ucy50cmltXG5cdFx0XHRtZXNzYWdlLnNsaWNlKDAsIG9wdGlvbnMudHJpbSlcblx0XHRlbHNlXG5cdFx0XHRtZXNzYWdlXG5cblxuXG5cblxuXG5cdG91dHB1dEZpbmFsTG9ncyA9ICgpLT4gaWYgT2JqZWN0LmtleXMoZmluYWxMb2dzLmxvZykubGVuZ3RoIG9yIE9iamVjdC5rZXlzKGZpbmFsTG9ncy5lcnJvcikubGVuZ3RoXG5cdFx0cHJvY2Vzcy5zdGRvdXQud3JpdGUgJ1xcblxcbidcblx0XHRmb3IgZmlsZSxtZXNzYWdlIG9mIGZpbmFsTG9ncy5sb2dcblx0XHRcdGNvbnNvbGUubG9nIGNoYWxrLmJnV2hpdGUuYmxhY2suYm9sZChcIk91dHB1dFwiKSsnICcrY2hhbGsuZGltKGZpbGUpXG5cdFx0XHRjb25zb2xlLmxvZyBmb3JtYXRPdXRwdXRNZXNzYWdlKG1lc3NhZ2UpXG5cdFx0XG5cdFx0Zm9yIGZpbGUsbWVzc2FnZSBvZiBmaW5hbExvZ3MuZXJyb3Jcblx0XHRcdGNvbnNvbGUubG9nIGNoYWxrLmJnUmVkLndoaXRlLmJvbGQoXCJFcnJvclwiKSsnICcrY2hhbGsuZGltKGZpbGUpXG5cdFx0XHRjb25zb2xlLmxvZyBmb3JtYXRPdXRwdXRNZXNzYWdlKG1lc3NhZ2UpXG5cblx0XHRmaW5pc2goKVxuXG5cblxuXG5cblxuIl19
//# sourceURL=/Users/brian.kimball/Github/design-tokens/node_modules/foreach-cli/lib/foreach.coffee